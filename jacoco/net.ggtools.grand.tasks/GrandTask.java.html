<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GrandTask.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Grand: Graphical Representation of ANt Dependencies</a> &gt; <a href="index.source.html" class="el_package">net.ggtools.grand.tasks</a> &gt; <span class="el_source">GrandTask.java</span></div><h1>GrandTask.java</h1><pre class="source lang-java linenums">// $Id$
/* ====================================================================
 * Copyright (c) 2002-2003, Christophe Labouisse
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above
 *    copyright notice, this list of conditions and the following
 *    disclaimer in the documentation and/or other materials provided
 *    with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
 * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 */

package net.ggtools.grand.tasks;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Properties;

import net.ggtools.grand.ant.AntProject;
import net.ggtools.grand.exceptions.GrandException;
import net.ggtools.grand.filters.GraphFilter;
import net.ggtools.grand.graph.GraphProducer;
import net.ggtools.grand.graph.GraphWriter;
import net.ggtools.grand.log.AntLog;
import net.ggtools.grand.output.DotWriter;

import org.apache.tools.ant.BuildException;
import org.apache.tools.ant.BuildListener;
import org.apache.tools.ant.Project;
import org.apache.tools.ant.ProjectHelper;
import org.apache.tools.ant.Task;
import org.apache.tools.ant.taskdefs.Property;
import org.apache.tools.ant.types.PropertySet;

/**
 * A task to create graphs.
 *
 * @author Christophe Labouisse
 */
<span class="fc" id="L64">public class GrandTask extends Task {</span>

    /**
     * Field DEFAULT_OUTCONFIG_PREFIX.
     */
    private static final String DEFAULT_OUTCONFIG_PREFIX = &quot;dot&quot;;

    /**
     * Field buildFile.
     */
    private File buildFile;

    /**
     * Field output.
     */
    private File output;

    /**
     * Field outputConfigurationFile.
     */
    private File outputConfigurationFile;

    /**
     * Field outputConfigurationPrefix.
     */
    private String outputConfigurationPrefix;

    /**
     * The sets of properties to pass to the graphed project.
     */
<span class="fc" id="L94">    private final List&lt;PropertySet&gt; propertySets = new ArrayList&lt;PropertySet&gt;();</span>

    /**
     * Field filters.
     */
<span class="fc" id="L99">    private final List&lt;FilterType&gt; filters = new LinkedList&lt;FilterType&gt;();</span>

    /**
     * Field showGraphName.
     */
<span class="fc" id="L104">    private boolean showGraphName = false;</span>

    /**
     * Field inheritAll.
     */
<span class="fc" id="L109">    private boolean inheritAll = false;</span>

    /**
     * Field properties.
     */
<span class="fc" id="L114">    private final List&lt;Property&gt; properties = new LinkedList&lt;Property&gt;();</span>

    /**
     * Check the parameters validity before execution.
     *
     */
    private void checkParams() {
<span class="fc bfc" id="L121" title="All 2 branches covered.">        if (output == null) {</span>
<span class="fc" id="L122">            final String message = &quot;required attribute missing&quot;;</span>
<span class="fc" id="L123">            log(message, Project.MSG_ERR);</span>
<span class="fc" id="L124">            throw new BuildException(message);</span>
        }

<span class="fc bfc" id="L127" title="All 4 branches covered.">        if (outputConfigurationFile != null &amp;&amp; outputConfigurationPrefix != null) {</span>
<span class="fc" id="L128">            final String message = &quot;cannot specify both outputconfigfile and outputconfigprefix&quot;;</span>
<span class="fc" id="L129">            log(message, Project.MSG_ERR);</span>
<span class="fc" id="L130">            throw new BuildException(message);</span>
        }

<span class="fc bfc" id="L133" title="All 2 branches covered.">        for (FilterType filter : filters) {</span>
<span class="fc" id="L134">            filter.checkParameters();</span>
<span class="fc" id="L135">        }</span>
<span class="fc" id="L136">    }</span>

    /**
     * Method execute.
     * @see org.apache.tools.ant.Task#execute()
     */
    @Override
    public final void execute() {
<span class="fc" id="L144">        checkParams();</span>

<span class="fc" id="L146">        final GraphProducer graphProject = initAntProject();</span>

<span class="fc" id="L148">        log(&quot;Done loading project &quot;, Project.MSG_VERBOSE);</span>

<span class="fc" id="L150">        log(&quot;Setting up filter chain&quot;);</span>
<span class="fc" id="L151">        GraphProducer producer = graphProject;</span>
<span class="fc" id="L152">        int numFilters = 0;</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">        for (FilterType f : filters) {</span>
<span class="fc" id="L155">            log(&quot;Adding filter &quot; + f.getFilterName(), Project.MSG_VERBOSE);</span>
<span class="fc" id="L156">            final GraphFilter filter = f.getFilter();</span>
<span class="fc" id="L157">            filter.setProducer(producer);</span>
<span class="fc" id="L158">            producer = filter;</span>
<span class="fc" id="L159">            numFilters++;</span>
<span class="fc" id="L160">        }</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (numFilters &gt; 0) {</span>
<span class="fc" id="L163">            log(&quot;Loaded &quot; + numFilters + &quot; filter&quot;</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                    + ((numFilters &gt; 1) ? &quot;s&quot; : &quot;&quot;));</span>
        }

        try {
<span class="fc" id="L168">            Properties override = null;</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">            if (outputConfigurationFile != null) {</span>
<span class="fc" id="L170">                log(&quot;Overriding default output configuration from &quot; + outputConfigurationFile);</span>
<span class="fc" id="L171">                override = new Properties();</span>
<span class="fc" id="L172">                override.load(new FileInputStream(outputConfigurationFile));</span>
            }
<span class="fc bfc" id="L174" title="All 2 branches covered.">            if (outputConfigurationPrefix != null) {</span>
<span class="fc" id="L175">                log(&quot;Overriding default output configuration from project properties &quot;</span>
                        + outputConfigurationPrefix + &quot;.*&quot;);
<span class="fc" id="L177">                override = new Properties();</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">                for (String property : getProject().getProperties().keySet()) {</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">                    if (property.startsWith(outputConfigurationPrefix)) {</span>
                        // one may use &amp;quot; or &amp;apos; or just ' in project properties
<span class="fc" id="L181">                        override.put(property.replace(outputConfigurationPrefix, DEFAULT_OUTCONFIG_PREFIX),</span>
<span class="fc" id="L182">                                getProject().getProperty(property).replaceAll(&quot;'&quot;, &quot;\&quot;&quot;));</span>
                    }
<span class="fc" id="L184">                }</span>
            }

<span class="fc" id="L187">            final GraphWriter writer = new DotWriter(override);</span>
<span class="fc" id="L188">            writer.setProducer(producer);</span>
<span class="fc" id="L189">            writer.setShowGraphName(showGraphName);</span>

<span class="fc" id="L191">            log(&quot;Writing output to &quot; + output);</span>
<span class="fc" id="L192">            writer.write(output);</span>
<span class="nc" id="L193">        } catch (final IOException e) {</span>
<span class="nc" id="L194">            log(&quot;Cannot write graph&quot;, Project.MSG_ERR);</span>
<span class="nc" id="L195">            throw new BuildException(&quot;Cannot write graph&quot;, e);</span>
<span class="nc" id="L196">        } catch (final GrandException e) {</span>
<span class="nc" id="L197">            log(&quot;Cannot process graph&quot;, Project.MSG_ERR);</span>
<span class="nc" id="L198">            throw new BuildException(&quot;Cannot write graph&quot;, e);</span>
<span class="fc" id="L199">        }</span>
<span class="fc" id="L200">    }</span>

    /**
     * Create and initialize a GraphProducer according to the
     * task parameters.
     *
     * @return an initialized GraphProducer.
     */
    private GraphProducer initAntProject() {

        Project antProject;

<span class="fc bfc" id="L212" title="All 2 branches covered.">        if (buildFile == null) {</span>
            // Working with current project
<span class="fc" id="L214">            log(&quot;Using current project&quot;);</span>
<span class="fc" id="L215">            antProject = getProject();</span>
        } else {
            // Open a new project.
<span class="fc" id="L218">            log(&quot;Loading project &quot; + buildFile);</span>

<span class="fc" id="L220">            antProject = loadNewProject();</span>
        }

<span class="fc bfc" id="L223" title="All 2 branches covered.">        for (PropertySet ps : propertySets) {</span>
<span class="fc" id="L224">            addAlmostAll(antProject, ps.getProperties());</span>
<span class="fc" id="L225">        }</span>

<span class="fc bfc" id="L227" title="All 2 branches covered.">        if (properties.size() &gt; 0) {</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">            for (Property prop : properties) {</span>
<span class="fc" id="L229">                prop.setProject(antProject);</span>
<span class="fc" id="L230">                prop.setTaskName(&quot;property&quot;);</span>
<span class="fc" id="L231">                prop.execute();</span>
<span class="fc" id="L232">            }</span>
        }

<span class="fc" id="L235">        return new AntProject(antProject);</span>
    }

    /**
     * Load an initialize a new project from a Ant build file.
     *
     * @return a new initialized Ant project.
     */
    private Project loadNewProject() {
<span class="fc" id="L244">        final Project antProject = new Project();</span>

        // Set the current project listeners to the graphed project
        // in order to get some trace if we need to execute some tasks
        // in the graphed project.
<span class="fc bfc" id="L249" title="All 2 branches covered.">        for (final BuildListener listener : getProject().getBuildListeners()) {</span>
<span class="fc" id="L250">            antProject.addBuildListener(listener);</span>
<span class="fc" id="L251">        }</span>

<span class="fc" id="L253">        antProject.init();</span>

<span class="fc bfc" id="L255" title="All 2 branches covered.">        if (!inheritAll) {</span>
            // set Java built-in properties separately,
            // b/c we won't inherit them.
<span class="fc" id="L258">            antProject.setSystemProperties();</span>

        } else {
            // set all properties from calling project
<span class="fc" id="L262">            final Properties props = new Properties();</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">            for (Map.Entry&lt;String, Object&gt; entry : getProject().getProperties().entrySet()) {</span>
<span class="fc" id="L264">                props.put(entry.getKey(), entry.getValue());</span>
<span class="fc" id="L265">            }</span>
<span class="fc" id="L266">            addAlmostAll(antProject, props);</span>
        }

<span class="fc" id="L269">        antProject.setUserProperty(&quot;ant.file&quot;, buildFile.getAbsolutePath());</span>
<span class="fc" id="L270">        final ProjectHelper loader = ProjectHelper.getProjectHelper();</span>
<span class="fc" id="L271">        antProject.addReference(&quot;ant.projectHelper&quot;, loader);</span>
<span class="fc" id="L272">        loader.parse(antProject, buildFile);</span>

<span class="fc" id="L274">        getProject().copyUserProperties(antProject);</span>

<span class="fc" id="L276">        return antProject;</span>
    }

    /**
     * Method setProject.
     * @param project Project
     * @see org.apache.tools.ant.ProjectComponent#setProject(org.apache.tools.ant.Project)
     */
    @Override
    public final void setProject(final Project project) {
<span class="fc" id="L286">        super.setProject(project);</span>
<span class="fc" id="L287">        AntLog.setCurrentProject(project);</span>
<span class="fc" id="L288">        AntLog.setCurrentTask(this);</span>
<span class="fc" id="L289">    }</span>

    /**
     * Sets the buildFile.
     *
     * @param file File
     */
    public final void setBuildFile(final File file) {
<span class="fc" id="L297">        buildFile = file;</span>
<span class="fc" id="L298">    }</span>

    /**
     * Sets the output file.
     *
     * @param file File
     */
    public final void setOutput(final File file) {
<span class="fc" id="L306">        output = file;</span>
<span class="fc" id="L307">    }</span>

    /**
     * Set a property file to override the output default configuration.
     * @deprecated use {@link #setOutputConfigFile(File)}.
     * @param propertyFile File
     */
    @Deprecated
    public final void setPropertyFile(final File propertyFile) {
<span class="nc" id="L316">        log(&quot;Using of deprecated \&quot;propertyfile\&quot; attribute, use \&quot;outputconfigfile\&quot; from now on&quot;,</span>
                Project.MSG_WARN);
<span class="nc" id="L318">        outputConfigurationFile = propertyFile;</span>
<span class="nc" id="L319">    }</span>

    /**
     * Set a property file to override the output default configuration.
     * @param propertyFile File
     */
    public final void setOutputConfigFile(final File propertyFile) {
<span class="fc" id="L326">        outputConfigurationFile = propertyFile;</span>
<span class="fc" id="L327">    }</span>

    /**
     * Set a property prefix to override the output default configuration.
     * @param propertyPrefix String
     */
    public final void setOutputConfigPrefix(final String propertyPrefix) {
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">        if (propertyPrefix == null) {</span>
<span class="nc" id="L335">            return;</span>
        }
<span class="pc bpc" id="L337" title="1 of 2 branches missed.">        if (propertyPrefix.isEmpty()) {</span>
<span class="nc" id="L338">            outputConfigurationPrefix = DEFAULT_OUTCONFIG_PREFIX;</span>
<span class="nc" id="L339">            return;</span>
        }
<span class="fc" id="L341">        outputConfigurationPrefix = propertyPrefix;</span>
<span class="fc" id="L342">    }</span>

    /**
     * Method setShowGraphName.
     * @param show boolean
     */
    public final void setShowGraphName(final boolean show) {
<span class="fc" id="L349">        showGraphName = show;</span>
<span class="fc" id="L350">    }</span>

    /**
     * If true, pass all properties to the new Ant project.
     * Defaults to true.
     * @param value if true pass all properties to the new Ant project.
     */
    public final void setInheritAll(final boolean value) {
<span class="fc" id="L358">        inheritAll = value;</span>
<span class="fc" id="L359">    }</span>

    /**
     * Add a filter to the task.
     * @param filter FilterType
     */
    public final void addFilter(final FilterType filter) {
<span class="fc" id="L366">        filters.add(filter);</span>
<span class="fc" id="L367">    }</span>

    /**
     * Add a new property to be passed to the graphed project.
     *
     * @param p the property to set.
     */
    public final void addProperty(final Property p) {
<span class="fc" id="L375">        properties.add(p);</span>
<span class="fc" id="L376">    }</span>

    /**
     * Set of properties to pass to the graphed project.
     *
     * @param ps property set to add
     */
    public final void addPropertyset(final PropertySet ps) {
<span class="fc" id="L384">        propertySets.add(ps);</span>
<span class="fc" id="L385">    }</span>

    /**
     * Copies all properties from the given table to the destination project -
     * omitting those that have already been set in the destination project as
     * well as properties named basedir or ant.file.
     * @param props properties to copy to the new project
     * @since Ant 1.6
     * @param destProject Project
     */
    private void addAlmostAll(final Project destProject, final Properties props) {
<span class="fc bfc" id="L396" title="All 2 branches covered.">        for (Map.Entry&lt;Object, Object&gt; entry : props.entrySet()) {</span>
<span class="fc" id="L397">            final String key = entry.getKey().toString();</span>
<span class="fc bfc" id="L398" title="All 4 branches covered.">            if (&quot;basedir&quot;.equals(key) || &quot;ant.file&quot;.equals(key)) {</span>
                // basedir and ant.file should not be altered.
<span class="fc" id="L400">                continue;</span>
            }

<span class="fc" id="L403">            final String value = entry.getValue().toString();</span>
            // don't re-set user properties, avoid the warning message
<span class="fc bfc" id="L405" title="All 2 branches covered.">            if (destProject.getProperty(key) == null) {</span>
                // no user property
<span class="fc" id="L407">                destProject.setNewProperty(key, value);</span>
            }
<span class="fc" id="L409">        }</span>
<span class="fc" id="L410">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>